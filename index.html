<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ç©ºå®¤ï¼†å¹³å‡ä¾¡æ ¼ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ï¼ˆæœ¬ç•ªãƒ»å‹•çš„ç‰ˆï¼‰</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
body { background:#f7f8fa; margin:0; font-family:'Noto Sans JP',sans-serif; }
.main { max-width:1500px; margin:30px auto 40px auto; background:#fff; border-radius:36px; box-shadow:0 4px 32px #d9e2ef99; padding:36px 24px 36px 48px; }
h1 { margin:0 0 8px 0; font-size:40px; }
h2 { margin:8px 0 0 0; font-size:22px; color:#444; }
.banner { width:380px; margin-bottom:12px; }
.flex { display:flex; gap:36px; flex-wrap:wrap; }
.calendar-wrap { flex:1 1 48%; min-width:370px; }
.calendar-title { font-size:28px; margin-bottom:4px; font-weight:700; color:#222; }
table.calendar { border-collapse:collapse; border-radius:16px; overflow:hidden; margin-bottom:14px; background:#f5f7fb; }
.calendar th, .calendar td { width:84px; height:80px; border:1px solid #e0e4ef; text-align:center; font-size:19px; vertical-align:top; background:#fff; padding:0; position:relative; }
.calendar th.sun, .calendar td.sun { color:#e1000a; }
.calendar th.sat, .calendar td.sat { color:#1b6ace; }
.calendar td.hol { background:#fff5f5; }
.calendar td.today { background:#bdf7d3; }
.calendar td.out { background:#f5f7fb; color:#bbb; }
.daynum { font-weight:bold; font-size:22px; margin-bottom:2px; }
.diff.pos { color:#2176d2; font-size:14px; margin-left:2px; }
.diff.neg { color:#e94343; font-size:14px; margin-left:2px; }
.price-up { color:#e03e3e; font-size:17px; margin-left:3px; }
.price-down { color:#208ad8; font-size:17px; margin-left:3px; }
.fire { font-size:18px; margin-left:4px; position:absolute; right:6px; top:4px; }
.fire1 { color:#ff9800; }
.fire2 { color:#ff5722; }
.fire3 { color:#ff1744; }
.fire4 { color:#c51162; }
.fire5 { color:#6d00c4; font-weight:bold; }
.event-kyocera { display:block; color:#b10000; font-size:14px; margin-top:2px; }
.event-other { display:block; color:#222; font-size:13px; }
.nav { display:flex; gap:20px; margin-bottom:20px; }
.nav button { background:#fff; border:1.5px solid #b9b9c9; border-radius:10px; padding:8px 18px; font-size:18px; font-weight:500; cursor:pointer; }
.nav button:hover { background:#f3f3fa; border-color:#e53939; color:#e53939; }
@media (max-width:1100px) { .flex { flex-direction:column; } .calendar-wrap { min-width:320px; } }
</style>
</head>
<body>
<div class="main">
    <img src="ãƒãƒŠãƒ¼ç”»åƒ3.png" class="banner" alt="ãƒãƒŠãƒ¼ç”»åƒ">
    <h1>ç©ºå®¤ï¼†å¹³å‡ä¾¡æ ¼ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</h1>
    <div id="last-update" style="color:#2baf71;font-size:18px; margin-bottom:7px;">æœ€çµ‚å·¡å›æ™‚åˆ»ï¼š-</div>
    <div class="nav">
        <button onclick="prevMonth()">â¬…ï¸ å‰æœˆ</button>
        <button onclick="goToday()">ğŸ“… å½“æœˆ</button>
        <button onclick="nextMonth()">â¡ï¸ æ¬¡æœˆ</button>
    </div>
    <div class="flex" id="calendar-blocks"></div>
    <div id="graph-block" style="margin-top:30px;"></div>
    <h2>æ—¥ä»˜ã‚’é¸æŠã™ã‚‹ã¨æ¨ç§»ã‚°ãƒ©ãƒ•ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</h2>
    <div style="margin:16px 0 8px 0; color:#222;">
        <b>ã€Šæ³¨é‡ˆã€‹</b><br>
        ãƒ»åœ¨åº«æ•°ã€å¹³å‡ä¾¡æ ¼ã¯ã€Œãªã‚“ã°ãƒ»å¿ƒæ–æ©‹ãƒ»å¤©ç‹å¯ºãƒ»é˜¿å€é‡ãƒ»é•·å±…ã€ã‚¨ãƒªã‚¢ã‹ã‚‰æŠ½å‡ºã—ã¦ã„ã¾ã™ã€‚<br>
        ãƒ»è¡¨ç¤ºã•ã‚Œã‚‹ã€Œå¹³å‡ä¾¡æ ¼ã€ã¯ã€æ¥½å¤©ãƒˆãƒ©ãƒ™ãƒ«æ¤œç´¢ä¸Šä½90æ–½è¨­ã®å¹³å‡æœ€å®‰å€¤ã§ã™ã€‚<br>
        ãƒ»ç©ºå®¤æ•°ã®ï¼ˆ<span class="diff pos">+N</span>ï¼<span class="diff neg">-N</span>ï¼‰ã¯ã€å‰å›å·¡å›æ™‚ç‚¹ã¨ã®åœ¨åº«æ•°ã®å¢—æ¸›ã‚’ç¤ºã—ã¾ã™ã€‚<br>
        ãƒ»å¹³å‡ä¾¡æ ¼ã® <span class="price-up">â†‘</span>ï¼<span class="price-down">â†“</span>ã¯ã€å‰å›å·¡å›æ™‚ç‚¹ã¨ã®å¹³å‡ä¾¡æ ¼ã®ä¸Šæ˜‡ï¼ä¸‹é™ã‚’ç¤ºã—ã¾ã™ã€‚<br>
        ãƒ»ä¼šå ´ã‚¢ã‚¤ã‚³ãƒ³ï¼š<span class="event-kyocera">ğŸ”´äº¬ã‚»ãƒ©ãƒ‰ãƒ¼ãƒ </span>ï¼<span style="color:#1976d2;">ğŸ”µãƒ¤ãƒ³ãƒãƒ¼ã‚¹ã‚¿ã‚¸ã‚¢ãƒ </span>ï¼<span class="event-other">â˜…ãã®ä»–ä¼šå ´</span><br>
        ãƒ»ç‚ãƒãƒ¼ã‚¯ï¼ˆéœ€è¦ã‚·ãƒ³ãƒœãƒ«ï¼‰ã®å†…è¨³ï¼š<br>
        <span class="fire fire1">ğŸ”¥1</span>ï¼šæ®‹å®¤â‰¤250 or ä¾¡æ ¼â‰¥25,000å††ã€€
        <span class="fire fire2">ğŸ”¥2</span>ï¼šæ®‹å®¤â‰¤200 or ä¾¡æ ¼â‰¥30,000å††ã€€
        <span class="fire fire3">ğŸ”¥3</span>ï¼šæ®‹å®¤â‰¤150 or ä¾¡æ ¼â‰¥35,000å††ã€€
        <span class="fire fire4">ğŸ”¥4</span>ï¼šæ®‹å®¤â‰¤100 or ä¾¡æ ¼â‰¥40,000å††ã€€
        <span class="fire fire5">ğŸ”¥5</span>ï¼šæ®‹å®¤â‰¤70 or ä¾¡æ ¼â‰¥50,000å††
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// è¨­å®šï¼šãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹
const CACHE_URL = "vacancy_price_cache.json";
const EVENT_URL = "event_data.json"; // å¤‰æ›æ¸ˆã¿event_data.jsonãŒå¿…è¦

let monthOffset = 0;

function getMonthFirst(offset=0) {
    const d = new Date();
    d.setDate(1);
    d.setMonth(d.getMonth()+offset);
    return new Date(d.getFullYear(), d.getMonth(), 1);
}
function prevMonth() { monthOffset--; drawCalendars(); }
function nextMonth() { monthOffset++; drawCalendars(); }
function goToday() { monthOffset=0; drawCalendars(); }

let cacheData = {};
let eventData = {};
let holidays = {}; // {YYYY-MM-DD: true}

fetch(CACHE_URL).then(r=>r.json()).then(data=>{
    cacheData = data;
    updateLastUpdate();
    fetch(EVENT_URL)
      .then(r=>r.json()).then(ev=>{
          eventData = ev;
          drawCalendars();
      }).catch(()=>{ eventData = {}; drawCalendars(); });
}).catch(()=>{});

function updateLastUpdate() {
    // å·¡å›æœ€çµ‚æ—¥ï¼ˆcacheã®æœ€æ–°æ—¥ï¼‰ã‚’è‡ªå‹•è¡¨ç¤º
    let dates = Object.keys(cacheData).sort();
    if(dates.length){
        let last = dates[dates.length-1];
        document.getElementById("last-update").textContent = "æœ€çµ‚å·¡å›æ™‚åˆ»ï¼š" + last;
    }
}

function getFire(v, p) {
    if(v<=70 || p>=50000) return '<span class="fire fire5">ğŸ”¥5</span>';
    if(v<=100 || p>=40000) return '<span class="fire fire4">ğŸ”¥4</span>';
    if(v<=150 || p>=35000) return '<span class="fire fire3">ğŸ”¥3</span>';
    if(v<=200 || p>=30000) return '<span class="fire fire2">ğŸ”¥2</span>';
    if(v<=250 || p>=25000) return '<span class="fire fire1">ğŸ”¥1</span>';
    return "";
}

function drawCalendars() {
    let base = getMonthFirst(monthOffset);
    let next = getMonthFirst(monthOffset+1);
    let html = drawCalendar(base) + drawCalendar(next);
    document.getElementById("calendar-blocks").innerHTML = html;
}

function drawCalendar(monthDate) {
    let y = monthDate.getFullYear(), m = monthDate.getMonth();
    let first = new Date(y, m, 1);
    let last = new Date(y, m+1, 0);
    let today = (new Date()).toISOString().slice(0,10);
    let cal = `<div class="calendar-wrap"><div class="calendar-title">${y}å¹´ ${m+1}æœˆ</div><table class="calendar"><tr>
        <th class="sun">æ—¥</th><th>æœˆ</th><th>ç«</th><th>æ°´</th><th>æœ¨</th><th>é‡‘</th><th class="sat">åœŸ</th></tr>`;
    let d = new Date(y, m, 1-(first.getDay()));
    for(let w=0; w<6; w++){
        cal += "<tr>";
        for(let wd=0; wd<7; wd++, d.setDate(d.getDate()+1)){
            let iso = d.toISOString().slice(0,10);
            let isOut = (d.getMonth()!=m);
            let cellClass = [];
            if(wd==0) cellClass.push("sun");
            if(wd==6) cellClass.push("sat");
            if(isOut) cellClass.push("out");
            if(iso==today) cellClass.push("today");
            // TODO: ç¥æ—¥åˆ¤å®šï¼ˆä»Šã¯çœç•¥ï¼‰
            if(eventData[iso] && eventData[iso].length>0){
                cellClass.push("hol");
            }
            cal += `<td class="${cellClass.join(" ")}" data-date="${iso}" onclick="showGraph('${iso}')">`;
            if(isOut){
                cal += "</td>";
                continue;
            }
            cal += `<div class="daynum">${d.getDate()}</div>`;
            let rec = cacheData[iso] || {};
            if(rec.vacancy!==undefined){
                cal += `<div>${rec.vacancy}ä»¶</div>`;
                cal += `<div>Â¥${rec.avg_price}</div>`;
                if(rec.vacancy_diff>0) cal += `<span class="diff pos">+${rec.vacancy_diff}</span>`;
                if(rec.vacancy_diff<0) cal += `<span class="diff neg">${rec.vacancy_diff}</span>`;
                if(rec.avg_price_diff>0) cal += `<span class="price-up">â†‘</span>`;
                if(rec.avg_price_diff<0) cal += `<span class="price-down">â†“</span>`;
                cal += getFire(rec.vacancy, rec.avg_price);
            }
            // ã‚¤ãƒ™ãƒ³ãƒˆè¡¨ç¤º
            if(eventData[iso]){
                for(let ev of eventData[iso]){
                    if(ev.icon=="ğŸ”´") cal += `<span class="event-kyocera">${ev.icon}${ev.name}</span>`;
                    else if(ev.icon=="â˜…") cal += `<span class="event-other">${ev.icon}${ev.name}</span>`;
                    else cal += `<span class="event-other">${ev.icon}${ev.name}</span>`;
                }
            }
            cal += "</td>";
        }
        cal += "</tr>";
    }
    cal += "</table></div>";
    return cal;
}

// ã‚°ãƒ©ãƒ•æç”»
function showGraph(date) {
    // å±¥æ­´ãƒ‡ãƒ¼ã‚¿å¯¾å¿œã®å ´åˆã®ã¿ã€‚ã‚µãƒ³ãƒ—ãƒ«ãªã®ã§ãƒ©ãƒ³ãƒ€ãƒ ãƒ‡ãƒ¼ã‚¿
    let rec = cacheData[date];
    if(!rec) return;
    let dates = [], vacs = [], prices = [];
    // ä»®ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ
    for(let i=0;i<10;i++){
        let d = new Date(new Date(date).getTime() - (9-i)*24*3600*1000);
        let iso = d.toISOString().slice(0,10);
        dates.push(iso);
        let v = cacheData[iso]?.vacancy ?? Math.floor(Math.random()*300+100);
        let p = cacheData[iso]?.avg_price ?? Math.floor(Math.random()*20000+8000);
        vacs.push(v);
        prices.push(p);
    }
    let ctx = document.createElement("canvas");
    ctx.id = "graph-canvas";
    document.getElementById("graph-block").innerHTML = `<div><canvas id="graph-canvas"></canvas></div>`;
    new Chart(ctx, {
        type:'line',
        data: {
            labels:dates,
            datasets:[
                { label:'åœ¨åº«æ•°', data:vacs, borderColor:'#2275e7', yAxisID:'y', fill:false },
                { label:'å¹³å‡ä¾¡æ ¼', data:prices, borderColor:'#e15759', yAxisID:'y2', fill:false }
            ]
        },
        options:{
            responsive:true,
            plugins:{ legend:{ display:true } },
            scales:{
                y:{ type:'linear', position:'left', min:0 },
                y2:{ type:'linear', position:'right', min:0, grid:{ drawOnChartArea:false } }
            }
        }
    });
}
</script>
</body>
</html>
