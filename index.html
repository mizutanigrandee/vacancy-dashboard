<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ã‚ã¡ã‚ƒã„ã„ãƒ„ãƒ¼ãƒ« | ç©ºå®¤ï¼†å¹³å‡ä¾¡æ ¼ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</title>
  <link rel="icon" type="image/png" href="mechalogo.png">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- ç¥æ—¥åˆ¤å®šãƒ­ãƒ¼ã‚«ãƒ«JSã‚’å¿…ãšå…ˆã«èª­ã¿è¾¼ã¿ -->
  <script src="japanese-holidays.js"></script>

  <!-- æœ¬ç•ªè¿½åŠ CSSï¼ˆæ—¢å­˜style.cssã¯è§¦ã‚‰ãªã„ï¼‰ -->
  <style>
    /* ãƒˆã‚°ãƒ«ã®è¦‹ãŸç›® */
    .compare-toggle{
      display:inline-flex; align-items:center; gap:8px;
      font-size:13px; border:1px solid #b9b9c9; border-radius:16px;
      padding:6px 10px; background:#fff; cursor:pointer; user-select:none;
      box-shadow:0 1px 3px rgba(0,0,0,.06);
    }
    .compare-toggle[aria-pressed="true"]{ background:#f7f7fb; }
    .compare-toggle .dot{ width:10px; height:10px; border-radius:999px; background:#bbb; }
    .compare-toggle[aria-pressed="true"] .dot{ background:#2d9cdb; }

    /* æ¯”è¼ƒãƒ¢ãƒ¼ãƒ‰ONæ™‚ã¯ã‚¤ãƒ™ãƒ³ãƒˆè¡Œã‚’éš ã™ï¼ˆè‡ªç¤¾è¡Œã®ã‚¹ãƒšãƒ¼ã‚¹ç¢ºä¿ï¼‰ */
    body.cm-on .cell-event-list { display: none !important; }

/* å³ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’åŸºæº–ã«ã™ã‚‹ */
.calendar-container{ 
  position: relative; 
  overflow: visible !important; 
}

/* PCç”¨ï¼šã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æ å¤–å³ä¸Šã«æµ®ã‹ã›ã‚‹ */
.calendar-container{ position: relative; overflow: visible !important; }
.compare-toggle-fixed{
  position: absolute;
  top: -36px;
  right: -8px;
  z-index: 3000;
  pointer-events: auto;
}

/* ã‚¹ãƒãƒ›ç”¨ï¼šãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã®ä¸‹ã«å³å¯„ã› */
@media (max-width:768px){
  .compare-toggle-fixed{
    position: relative;
    top: 8px;
    right: 0;
    margin-left: auto;
    width: fit-content;
    transform: scale(.9);
    transform-origin: right center;
  }
}



    /* è‡ªç¤¾è¡Œã®è¦‹ãŸç›®ï¼ˆONæ™‚ã ã‘å·®ã—è¾¼ã‚€ï¼‰ */
    .myline{ margin-top:2px; font-size:12px; line-height:1.2; white-space:nowrap; }
    .myline.off{ opacity:.5; }
    .myline .up{ color:#d9534f; }     /* å¹³å‡ã‚ˆã‚Šé«˜ã„ï¼èµ¤ */
    .myline .down{ color:#0275d8; }   /* å¹³å‡ã‚ˆã‚Šå®‰ã„ï¼é’ */
    .myline .neutral{ color:#666; }

    /* è‡ªç¤¾æ¯”è¼ƒãƒ¢ãƒ¼ãƒ‰ONæ™‚ã¯ã€%å·®ã®å°ã•ãªèµ¤/é’è¡¨ç¤ºã‚’éš ã™ */
    body.cm-on .myline .up,
    body.cm-on .myline .down,
    body.cm-on .myline .neutral {
      display: none !important;
    }

        /* ã‚¹ãƒãƒ›è¡¨ç¤ºæ™‚ã«è‡ªç¤¾è¡Œã®æ–‡å­—ã‚µã‚¤ã‚ºã‚’å°ã•ãã—ã¦æ å†…ã«åã‚ã‚‹ */
    @media (max-width:768px){
      .myline {
        font-size:7px;
        line-height:1.1;
      }
    }
  </style>
</head>
<body>
  <header class="app-header">
    <img src="ãƒãƒŠãƒ¼ç”»åƒ3.png" class="app-banner" alt="ãƒãƒŠãƒ¼">
  </header>

  <!-- éœ€è¦æ€¥é¨°æ—¥å±¥æ­´ãƒãƒŠãƒ¼ -->
  <div id="spike-banner"></div>

  <!-- æœˆé€ã‚Šãƒœã‚¿ãƒ³ -->
  <div class="nav-button-container">
    <button id="prevMonthBtn" class="custom-button"><span class="icon">â¬…ï¸</span> å‰æœˆ</button>
    <button id="currentMonthBtn" class="custom-button"><span class="icon">ğŸ“…</span> å½“æœˆ</button>
    <button id="nextMonthBtn" class="custom-button"><span class="icon">â¡ï¸</span> æ¬¡æœˆ</button>
  </div>

  <main class="calendar-main">
    <div class="graph-side" id="graph-container"></div>

    <!-- å³ï¼šã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ï¼ˆä¸­èº«ã¯ app.js ãŒæç”»ï¼‰ -->
    <div class="calendar-container" id="calendar-container">
      <!-- JS ãŒæœ«å°¾ã«ãƒˆã‚°ãƒ«ã‚’é‡ã­ã¦è¿½åŠ ã—ã¾ã™ -->
    </div>
  </main>

  <footer class="app-footer">
    <div id="last-update"></div>
    <div class="footer-note">
      <strong>ã€Šæ³¨é‡ˆã€‹</strong><br>
      ãƒ»åœ¨åº«æ•°ã€å¹³å‡ä¾¡æ ¼ã¯ã€Œãªã‚“ã°ãƒ»å¿ƒæ–æ©‹ãƒ»å¤©ç‹å¯ºãƒ»é˜¿å€é‡ãƒ»é•·å±…ã€ã‚¨ãƒªã‚¢ã‹ã‚‰æŠ½å‡ºã—ã¦ã„ã¾ã™ã€‚<br>
      ãƒ»è¡¨ç¤ºã•ã‚Œã‚‹ã€Œå¹³å‡ä¾¡æ ¼ã€ã¯ã€æ¥½å¤©ãƒˆãƒ©ãƒ™ãƒ«æ¤œç´¢ä¸Šä½æ–½è¨­ã®<strong>1å1å®¤ã®æœ€å®‰ä¾¡æ ¼</strong>ã‚’æ–½è¨­ã”ã¨ã«å–ã‚Šå‡ºã—ã€ãã®å¹³å‡ã§ã™ã€‚<br>
      ãƒ»è‡ªç¤¾ä¾¡æ ¼ã¯<strong>1å1å®¤ã®æœ€å®‰</strong>ã®æœ€æ–°å€¤ã‚’è¡¨ç¤ºï¼ˆå±¥æ­´ã¯ä¿æŒã—ãªã„å¯è¦–åŒ–ã§ã™ï¼‰ã€‚<br>
      ãƒ»ç©ºå®¤æ•°ã® <span style="color:blue;">ï¼ˆ+Nï¼‰</span> / <span style="color:red;">ï¼ˆâˆ’Nï¼‰</span> ã¯ã€å‰å›å·¡å›æ™‚ç‚¹ã¨ã®åœ¨åº«æ•°ã®å¢—æ¸›ã§ã™ã€‚<br>
      ãƒ»å¹³å‡ä¾¡æ ¼ã® <span style="color:red;">â†‘</span> / <span style="color:blue;">â†“</span> ã¯ã€å‰å›å·¡å›æ™‚ç‚¹ã¨ã®å¹³å‡ä¾¡æ ¼ã®ä¸Šæ˜‡/ä¸‹é™ã§ã™ã€‚<br>
      ãƒ»ä¼šå ´ã‚¢ã‚¤ã‚³ãƒ³ï¼š<span style="color:#e53939;">ğŸ”´</span>äº¬ã‚»ãƒ©ãƒ‰ãƒ¼ãƒ  / <span style="color:#357ebd;">ğŸ”µ</span>ãƒ¤ãƒ³ãƒãƒ¼ã‚¹ã‚¿ã‚¸ã‚¢ãƒ  / <span style="color:#888;">â˜…</span>ãã®ä»–ä¼šå ´<br>
      ãƒ»ç‚ãƒãƒ¼ã‚¯ï¼ˆéœ€è¦ã‚·ãƒ³ãƒœãƒ«ï¼‰ã®å†…è¨³ï¼š<br>
      ã€€ã€€<span style="color:#ffa600;">ğŸ”¥1</span>ï¼šæ®‹å®¤ â‰¤250 ã¾ãŸã¯ ä¾¡æ ¼ â‰¥25,000å††<br>
      ã€€ã€€<span style="color:#be0c0c;">ğŸ”¥2</span>ï¼šæ®‹å®¤ â‰¤200 ã¾ãŸã¯ ä¾¡æ ¼ â‰¥30,000å††<br>
      ã€€ã€€<span style="color:#e94e77;">ğŸ”¥3</span>ï¼šæ®‹å®¤ â‰¤150 ã¾ãŸã¯ ä¾¡æ ¼ â‰¥35,000å††<br>
      ã€€ã€€<span style="color:#ff6600;">ğŸ”¥4</span>ï¼šæ®‹å®¤ â‰¤100 ã¾ãŸã¯ ä¾¡æ ¼ â‰¥40,000å††<br>
      ã€€ã€€<span style="color:#421c16;">ğŸ”¥5</span>ï¼šæ®‹å®¤ â‰¤70 ã¾ãŸã¯ ä¾¡æ ¼ â‰¥50,000å††<br>
    </div>
  </footer>

  <!-- æœ¬ç•ªï¼šæ¯”è¼ƒãƒˆã‚°ãƒ« & è‡ªç¤¾è¡Œå·®ã—è¾¼ã¿ï¼ˆtestã§å®‰å®šã—ãŸå®Ÿè£…ã‚’è¸è¥²ï¼‰ -->
  <script>
    (function(){
      const KEY = "compareMode";

      // åˆå›ãƒ­ãƒ¼ãƒ‰æ™‚ã ã‘ OFF ã«åˆæœŸåŒ–ï¼ˆã“ã®ã‚¿ãƒ–ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸­1å›ã ã‘ï¼‰
      if (!sessionStorage.getItem("cmpInitDone")) {
        if (localStorage.getItem(KEY) !== "0" && localStorage.getItem(KEY) !== "1") {
          localStorage.setItem(KEY, "0");
        }
        sessionStorage.setItem("cmpInitDone", "1");
      }

      // æ—¢å­˜ãƒãƒ£ãƒ¼ãƒˆç ´æ£„ï¼†å†æç”»
      function applyToggleAndRedraw(){
        if (window.sc) { try { window.sc.destroy(); } catch(e){} window.sc = null; }
        if (window.pc) { try { window.pc.destroy(); } catch(e){} window.pc = null; }
        if (typeof renderPage === "function") renderPage();
      }

      // è¦‹ãŸç›®æ›´æ–°ï¼ˆbodyã«cm-onã‚¯ãƒ©ã‚¹ä»˜ä¸ï¼‰
      function updateToggleUI(on){
        const btn = document.getElementById("compareToggle");
        const st  = document.getElementById("toggleState");
        if (btn) btn.setAttribute("aria-pressed", on ? "true" : "false");
        if (st)  st.textContent = on ? "ON" : "OFF";
        document.body.classList.toggle("cm-on", !!on);
      }

      // ã‚°ãƒ­ãƒ¼ãƒãƒ«å…¬é–‹ï¼šapp.js ã‹ã‚‰ã‚‚å‘¼ã¹ã‚‹
      window.ensureCompareToggle = function ensureCompareToggle(){
        const container = document.getElementById("calendar-container");
        if (!container) return;

        let holder = document.getElementById("compareToggleHolder");
        if (!holder) {
          holder = document.createElement("div");
          holder.id = "compareToggleHolder";
          holder.className = "compare-toggle-fixed";
          holder.setAttribute("data-ignore", "compare-toggle");
          holder.innerHTML = `
            <button id="compareToggle" class="compare-toggle" aria-pressed="false" aria-label="è‡ªç¤¾æ¯”è¼ƒãƒ¢ãƒ¼ãƒ‰ã‚’åˆ‡æ›¿">
              <span class="dot" aria-hidden="true"></span>
              <span>è‡ªç¤¾æ¯”è¼ƒãƒ¢ãƒ¼ãƒ‰</span>
              <span id="toggleState">OFF</span>
            </button>`;
          container.appendChild(holder);

          document.getElementById("compareToggle").addEventListener("click", () => {
            const nowOn  = localStorage.getItem(KEY) === "1";
            const nextOn = !nowOn;
            localStorage.setItem(KEY, nextOn ? "1" : "0");
            updateToggleUI(nextOn);
            applyToggleAndRedraw();
          });
        }

        // çŠ¶æ…‹åæ˜ 
        updateToggleUI(localStorage.getItem(KEY) === "1");
      };

      // åˆæœŸèµ·å‹•æ™‚ï¼šä¸€åº¦ã ã‘è¨­ç½®ï¼ˆãã®å¾Œã¯ app.js å´ãŒæ¯å›å‘¼ã¶ï¼‰
      document.addEventListener("DOMContentLoaded", () => {
        if (typeof window.ensureCompareToggle === "function") window.ensureCompareToggle();
      });

      // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãŒæãæ›¿ã‚ã£ãŸã‚‰æ¯å›ãƒˆã‚°ãƒ«ã‚’å·®ã—ç›´ã™
      document.addEventListener("DOMContentLoaded", () => {
        const c = document.getElementById("calendar-container");
        if (c) {
          new MutationObserver(() => {
            if (window.ensureCompareToggle) window.ensureCompareToggle();
          }).observe(c, { childList: true, subtree: true });
        }
      });
    })();
  </script>

  <!-- è‡ªç¤¾ï¼šÂ¥â€¦ ã‚’ã‚»ãƒ«ã«å·®ã—è¾¼ã‚€ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°åŒ–ï¼‰ -->
  <script>
    (function(){
      const KEY = "compareMode";
      let CACHE = null, loading = null;

      async function ensureCache(){
        if (CACHE) return CACHE;
        if (!loading) loading = fetch("./vacancy_price_cache.json", {cache:"no-store"}).then(r=>r.json());
        CACHE = await loading;
        return CACHE;
      }
      function pctClass(p){ if(p===null||p===undefined) return "neutral"; return p>0?"up":(p<0?"down":"neutral"); }
      function pctText(p){ if(p===null||p===undefined) return "â€”"; return `${p>0?"+":""}${p}%`; }
      const isOn = () => localStorage.getItem(KEY) === "1";

      // ã‚°ãƒ­ãƒ¼ãƒãƒ«å…¬é–‹ï¼šapp.js ã‹ã‚‰æ¯å›å‘¼ã¹ã‚‹
      window.renderMyLines = async function renderMyLines(){
        // æ—¢å­˜ã€Œè‡ªç¤¾ã€è¡Œã‚’ä¸€æƒ
        document.querySelectorAll("#calendar-container .myline").forEach(el => el.remove());
        // OFFãªã‚‰çµ‚äº†
        if (!isOn()) return;

        const cache = await ensureCache();
        // å„æ—¥ã‚»ãƒ«ã«ã€Œè‡ªç¤¾ã€è¡Œã‚’è¿½åŠ 
        document.querySelectorAll('#calendar-container [data-date]').forEach(cell => {
          const iso = cell.getAttribute('data-date'); if (!iso) return;
          const rec = cache[iso]; if (!rec) return;

          const my  = Number(rec.my_price || 0);
          const pct = (typeof rec.my_vs_avg_pct === "number") ? rec.my_vs_avg_pct : null;

          const div = document.createElement("div");
          div.className = "myline" + (my>0 ? "" : " off");
          div.innerHTML = (my>0)
            ? `è‡ªç¤¾ï¼šÂ¥${my.toLocaleString()} <span class="${pctClass(pct)}">(${pctText(pct)})</span>`
            : `è‡ªç¤¾ï¼š-`;

          const after = cell.querySelector(".avg") || cell.lastElementChild || cell;
          after.insertAdjacentElement("afterend", div);
        });
      };

      // åˆå›ãƒ­ãƒ¼ãƒ‰æ™‚
      document.addEventListener("DOMContentLoaded", () => {
        window.renderMyLines && window.renderMyLines();
      });

      // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®æãæ›¿ãˆã‚’ç›£è¦–ã—ã¦éƒ½åº¦å·®ã—ç›´ã™
      document.addEventListener("DOMContentLoaded", () => {
        const cont = document.getElementById("calendar-container");
        if (cont) {
          new MutationObserver(() => {
            if (window.renderMyLines) window.renderMyLines();
          }).observe(cont, { childList: true, subtree: true });
        }
      });

      // ãƒˆã‚°ãƒ«ã‚¯ãƒªãƒƒã‚¯æ™‚ï¼ˆcompareToggleï¼‰â†’ å³åæ˜ 
      document.addEventListener("click", (e) => {
        if (e.target && (e.target.id === "compareToggle" || e.target.closest("#compareToggle"))) {
          // renderPage() ãŒèµ°ã‚‹å‰å¾Œã§äºŒåº¦å‘¼ã‚“ã§å–ã‚Šã“ã¼ã—é˜²æ­¢
          setTimeout(() => window.renderMyLines && window.renderMyLines(), 0);
          setTimeout(() => window.renderMyLines && window.renderMyLines(), 150);
        }
      });
    })();
  </script>

  <!-- æœ€å¾Œã«app.jsï¼ˆæœ¬ç•ªã¨åŒã˜ï¼‰ -->
  <script src="app.js"></script>
</body>
</html>
