<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>めちゃいいツール | 空室＆平均価格カレンダー（テスト）</title>
  <link rel="icon" type="image/png" href="mechalogo.png">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- 祝日判定ローカルJSを必ず先に読み込み -->
  <script src="japanese-holidays.js"></script>

  <!-- ▼ test専用 追記CSS（既存style.cssは触らない） -->
  <style>
    /* トグルの見た目 */
    .compare-toggle{
      display:inline-flex; align-items:center; gap:8px;
      font-size:13px; border:1px solid #b9b9c9; border-radius:16px;
      padding:6px 10px; background:#fff; cursor:pointer; user-select:none;
      box-shadow:0 1px 3px rgba(0,0,0,.06);
    }
    .compare-toggle[aria-pressed="true"]{ background:#f7f7fb; }
    .compare-toggle .dot{ width:10px; height:10px; border-radius:999px; background:#bbb; }
    .compare-toggle[aria-pressed="true"] .dot{ background:#2d9cdb; }

    /* 右カレンダー内の“右上”に重ねる（幅を押し広げない） */
    .calendar-container{ position: relative; overflow: visible !important; }
    .compare-toggle-fixed{ position:absolute; top:6px; right:8px; z-index:2000; pointer-events:auto; }
    @media (max-width:768px){ .compare-toggle-fixed{ right:4px; } }

    /* 自社行の見た目（ON時だけ差し込む） */
    .myline{ margin-top:2px; font-size:12px; line-height:1.2; white-space:nowrap; }
    .myline.off{ opacity:.5; }
    .myline .up{ color:#d9534f; }     /* 平均より高い＝赤 */
    .myline .down{ color:#0275d8; }   /* 平均より安い＝青 */
    .myline .neutral{ color:#666; }
  </style>
</head>
<body>
  <header class="app-header">
    <img src="バナー画像3.png" class="app-banner" alt="バナー">
  </header>

  <!-- 🚀需要急騰日履歴バナー -->
  <div id="spike-banner"></div>

  <!-- 月送りボタン -->
  <div class="nav-button-container">
    <button id="prevMonthBtn" class="custom-button"><span class="icon">⬅️</span> 前月</button>
    <button id="currentMonthBtn" class="custom-button"><span class="icon">📅</span> 当月</button>
    <button id="nextMonthBtn" class="custom-button"><span class="icon">➡️</span> 次月</button>
  </div>

  <main class="calendar-main">
    <div class="graph-side" id="graph-container"></div>

    <!-- 右：カレンダー（中身は app.js が描画） -->
    <div class="calendar-container" id="calendar-container">
      <!-- JS が末尾にトグルを重ねて追加します -->
    </div>
  </main>

  <footer class="app-footer">
    <div id="last-update"></div>
    <div class="footer-note">
      <strong>《注釈》</strong><br>
      ・在庫数、平均価格は「なんば・心斎橋・天王寺・阿倍野・長居」エリアから抽出しています。<br>
      ・表示される「平均価格」は、楽天トラベル検索上位施設の平均最低価格です。<br>
      ・空室数の <span style="color:blue;">（+N）</span> / <span style="color:red;">（−N）</span> は、前回巡回時点との在庫数の増減です。<br>
      ・平均価格の <span style="color:red;">↑</span> / <span style="color:blue;">↓</span> は、前回巡回時点との平均価格の上昇/下降です。<br>
      ・会場アイコン：<span style="color:#e53939;">🔴</span>京セラドーム / <span style="color:#357ebd;">🔵</span>ヤンマースタジアム / <span style="color:#888;">★</span>その他会場<br>
      ・炎マーク（需要シンボル）の内訳：<br>
      　　<span style="color:#ffa600;">🔥1</span>：残室 ≤250 または 価格 ≥25,000円<br>
      　　<span style="color:#be0c0c;">🔥2</span>：残室 ≤200 または 価格 ≥30,000円<br>
      　　<span style="color:#e94e77;">🔥3</span>：残室 ≤150 または 価格 ≥35,000円<br>
      　　<span style="color:#ff6600;">🔥4</span>：残室 ≤100 または 価格 ≥40,000円<br>
      　　<span style="color:#421c16;">🔥5</span>：残室 ≤70 または 価格 ≥50,000円<br>
    </div>
  </footer>

  <!-- ▼ test専用JS①：トグルの設置＆状態保存（app.jsは触らない） -->
  <script>
    (function(){
      const KEY="compareMode";
      const get=()=>localStorage.getItem(KEY)==="1";
      const set=(on)=>{ localStorage.setItem(KEY,on?"1":"0"); update(on); };
      function update(on){
        const b=document.getElementById("compareToggle"), s=document.getElementById("toggleState");
        if(b&&s){ b.setAttribute("aria-pressed", on?"true":"false"); s.textContent= on?"ON":"OFF"; }
      }
      function attachToggle(){
        const container=document.getElementById("calendar-container");
        if(!container) return;
        let holder=document.getElementById("compareToggleHolder");
        if(!holder || !container.contains(holder)){
          holder=document.createElement("div");
          holder.id="compareToggleHolder";
          holder.className="compare-toggle-fixed";
          holder.setAttribute("data-ignore","compare-toggle");
          holder.innerHTML=`
            <button id="compareToggle" class="compare-toggle" aria-pressed="false" aria-label="自社比較モードを切替">
              <span class="dot" aria-hidden="true"></span><span>自社比較モード</span><span id="toggleState">OFF</span>
            </button>`;
          container.appendChild(holder);   // ★ 末尾に追加（カレンダー本体と衝突しない）
          document.getElementById("compareToggle").addEventListener("click", ()=>set(!get()));
        }
        update(get());
      }
      document.addEventListener("DOMContentLoaded", ()=>{
        attachToggle();
        const target=document.getElementById("calendar-container");
        if(target){
          new MutationObserver(()=>attachToggle()).observe(target,{childList:true});
          const parent=target.parentElement;
          if(parent){ new MutationObserver(()=>attachToggle()).observe(parent,{childList:true}); }
        }
      });
    })();
  </script>

  <!-- ▼ test専用JS②：ON時だけセルに「自社：¥…（±%）」を差し込み -->
  <script>
    (function(){
      const KEY="compareMode";
      const isOn=()=>localStorage.getItem(KEY)==="1";
      let CACHE=null, loading=null;

      async function ensureCache(){
        if(CACHE) return CACHE;
        if(!loading) loading=fetch("./vacancy_price_cache.json",{cache:"no-store"}).then(r=>r.json());
        CACHE=await loading; return CACHE;
      }
      function pctClass(p){ if(p===null||p===undefined) return "neutral"; return p>0?"up":(p<0?"down":"neutral"); }
      function pctText(p){ if(p===null||p===undefined) return "—"; return `${p>0?"+":""}${p}%`; }

      async function renderMyLines(){
        // 既存を掃除
        document.querySelectorAll("#calendar-container .myline").forEach(el=>el.remove());
        if(!isOn()) return;  // OFFなら何もしない

        const cache=await ensureCache();
        // data-date を持つ日セルに挿入（無ければ何もしない＝安全）
        document.querySelectorAll('#calendar-container [data-date]').forEach(cell=>{
          const iso=cell.getAttribute('data-date'); if(!iso) return;
          const rec=cache[iso]; if(!rec) return;

          const my=Number(rec.my_price||0);
          const pct=(typeof rec.my_vs_avg_pct==="number")?rec.my_vs_avg_pct:null;

          const div=document.createElement("div");
          div.className="myline"+(my>0?"":" off");
          div.innerHTML=(my>0)
            ? `自社：¥${my.toLocaleString()} <span class="${pctClass(pct)}">(${pctText(pct)})</span>`
            : `自社：-`;

          const after=cell.querySelector(".avg") || cell.lastElementChild || cell;
          after.insertAdjacentElement("afterend", div);
        });
      }

      // カレンダーの再描画に追従
      const cont=document.getElementById("calendar-container");
      if(cont){ new MutationObserver(()=>renderMyLines()).observe(cont,{childList:true,subtree:true}); }

      // トグル変更ですぐ反映
      document.addEventListener("click", (e)=>{
        if(e.target && (e.target.id==="compareToggle" || e.target.closest("#compareToggle"))){
          // app.jsの再描画が走る可能性があるため少し遅らせる
          setTimeout(renderMyLines, 0);
        }
      });

      document.addEventListener("DOMContentLoaded", renderMyLines);
    })();
  </script>

  <!-- 最後にapp.js（本番と同じ） -->
  <script src="app.js"></script>
</body>
</html>
